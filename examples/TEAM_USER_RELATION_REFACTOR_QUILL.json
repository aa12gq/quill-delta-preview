[
  { "insert": "TeamUserRelation 重构说明", "attributes": { "header": 1 } },
  { "insert": "\n\n" },

  { "insert": "原有表结构", "attributes": { "header": 2 } },
  { "insert": "\n\n" },

  { "insert": "TeamUserRelation 表", "attributes": { "header": 3 } },
  { "insert": "\n\n" },

  { "insert": "字段", "attributes": { "bold": true } },
  { "insert": ":\n" },
  { "insert": "• " },
  { "insert": "id", "attributes": { "code": true } },
  { "insert": " (uint64): 主键\n" },
  { "insert": "• " },
  { "insert": "team_id", "attributes": { "code": true } },
  { "insert": " (uint64): 团队ID\n" },
  { "insert": "• " },
  { "insert": "user_id", "attributes": { "code": true } },
  { "insert": " (uint64): 用户ID\n" },
  { "insert": "• " },
  { "insert": "department_id", "attributes": { "code": true } },
  { "insert": " (uint64): 部门ID\n" },
  { "insert": "• " },
  { "insert": "position_id", "attributes": { "code": true } },
  { "insert": " (uint64): 职位ID\n" },
  { "insert": "• " },
  { "insert": "employee_number", "attributes": { "code": true } },
  { "insert": " (string): 员工编号\n" },
  { "insert": "• " },
  { "insert": "status", "attributes": { "code": true } },
  { "insert": " (uint8): 状态\n" },
  { "insert": "• " },
  { "insert": "entry_time", "attributes": { "code": true } },
  { "insert": " (int64): 入职时间\n" },
  { "insert": "• " },
  { "insert": "role_type", "attributes": { "code": true } },
  { "insert": " (uint8): 角色类型\n" },
  { "insert": "• " },
  { "insert": "start_time", "attributes": { "code": true } },
  { "insert": " (int64): 开始时间\n" },
  { "insert": "• " },
  { "insert": "end_time", "attributes": { "code": true } },
  { "insert": " (int64): 结束时间\n" },
  { "insert": "• " },
  { "insert": "is_primary", "attributes": { "code": true } },
  { "insert": " (uint8): 是否主要职位\n" },
  { "insert": "• " },
  { "insert": "remark", "attributes": { "code": true } },
  { "insert": " (string): 备注\n\n" },

  { "insert": "问题", "attributes": { "header": 3 } },
  { "insert": "\n" },
  { "insert": "1. " },
  { "insert": "不支持多部门多职位", "attributes": { "bold": true } },
  { "insert": ": 一个用户只能关联一个部门和一个职位\n" },
  { "insert": "2. " },
  { "insert": "数据冗余", "attributes": { "bold": true } },
  { "insert": ": 用户基础信息在多个记录中重复\n" },
  { "insert": "3. " },
  { "insert": "扩展性差", "attributes": { "bold": true } },
  { "insert": ": 难以支持复杂的组织架构\n" },
  { "insert": "4. " },
  { "insert": "查询复杂", "attributes": { "bold": true } },
  { "insert": ": 需要复杂的条件查询来获取用户信息\n\n" },

  { "insert": "新表结构", "attributes": { "header": 2 } },
  { "insert": "\n\n" },

  {
    "insert": "1. TeamUserRelation (团队用户基础关系表)",
    "attributes": { "header": 3 }
  },
  { "insert": "\n\n" },
  { "insert": "字段", "attributes": { "bold": true } },
  { "insert": ":\n" },
  { "insert": "• " },
  { "insert": "id", "attributes": { "code": true } },
  { "insert": " (uint64): 主键\n" },
  { "insert": "• " },
  { "insert": "team_id", "attributes": { "code": true } },
  { "insert": " (uint64): 团队ID\n" },
  { "insert": "• " },
  { "insert": "user_id", "attributes": { "code": true } },
  { "insert": " (uint64): 用户ID\n" },
  { "insert": "• " },
  { "insert": "employee_number", "attributes": { "code": true } },
  { "insert": " (string): 员工编号\n" },
  { "insert": "• " },
  { "insert": "status", "attributes": { "code": true } },
  { "insert": " (uint8): 状态\n" },
  { "insert": "• " },
  { "insert": "entry_time", "attributes": { "code": true } },
  { "insert": " (int64): 入职时间\n\n" },

  {
    "insert": "2. TeamMemberDepartment (团队成员部门职位关系表)",
    "attributes": { "header": 3 }
  },
  { "insert": "\n\n" },
  { "insert": "字段", "attributes": { "bold": true } },
  { "insert": ":\n" },
  { "insert": "• " },
  { "insert": "id", "attributes": { "code": true } },
  { "insert": " (uint64): 主键\n" },
  { "insert": "• " },
  { "insert": "team_user_relation_id", "attributes": { "code": true } },
  { "insert": " (uint64): 团队用户关系ID (外键)\n" },
  { "insert": "• " },
  { "insert": "department_id", "attributes": { "code": true } },
  { "insert": " (uint64): 部门ID (外键)\n" },
  { "insert": "• " },
  { "insert": "position_id", "attributes": { "code": true } },
  { "insert": " (uint64): 职位ID (外键)\n" },
  { "insert": "• " },
  { "insert": "role", "attributes": { "code": true } },
  { "insert": " (uint8): 角色 (0: 普通成员, 1: 部门主管)\n" },
  { "insert": "• " },
  { "insert": "start_time", "attributes": { "code": true } },
  { "insert": " (int64): 开始时间\n" },
  { "insert": "• " },
  { "insert": "end_time", "attributes": { "code": true } },
  { "insert": " (int64): 结束时间\n" },
  { "insert": "• " },
  { "insert": "is_primary", "attributes": { "code": true } },
  { "insert": " (uint8): 是否主要职位\n" },
  { "insert": "• " },
  { "insert": "remark", "attributes": { "code": true } },
  { "insert": " (string): 备注\n\n" },

  { "insert": "重构原因", "attributes": { "header": 2 } },
  { "insert": "\n" },
  { "insert": "• 将用户基础信息与职位信息分离\n" },
  { "insert": "• 支持一个用户在多个部门担任不同职位\n" },
  { "insert": "• 消除数据冗余，提高数据一致性\n" },
  { "insert": "• 简化查询逻辑，提高查询效率\n" },
  { "insert": "• 增强系统的扩展性和灵活性\n\n" },

  { "insert": "原有结构 vs 新结构", "attributes": { "header": 2 } },
  { "insert": "\n\n" },
  { "insert": "| 方面 | 原有结构 | 新结构 | 改进 |\n" },
  { "insert": "|------|----------|--------|------|\n" },
  { "insert": "| " },
  { "insert": "表数量", "attributes": { "bold": true } },
  { "insert": " | 1 个表 | 2 个表 | 职责分离更清晰 |\n" },
  { "insert": "| " },
  { "insert": "多部门支持", "attributes": { "bold": true } },
  { "insert": " | ❌ 不支持 | ✅ 支持 | 用户可在多个部门任职 |\n" },
  { "insert": "| " },
  { "insert": "多职位支持", "attributes": { "bold": true } },
  { "insert": " | ❌ 不支持 | ✅ 支持 | 用户可担任多个职位 |\n" },
  { "insert": "| " },
  { "insert": "数据冗余", "attributes": { "bold": true } },
  { "insert": " | ❌ 存在冗余 | ✅ 消除冗余 | 用户基础信息不重复 |\n" },
  { "insert": "| " },
  { "insert": "查询复杂度", "attributes": { "bold": true } },
  { "insert": " | ❌ 复杂 | ✅ 简化 | 针对性查询更高效 |\n" },
  { "insert": "| " },
  { "insert": "扩展性", "attributes": { "bold": true } },
  { "insert": " | ❌ 较差 | ✅ 良好 | 易于添加新功能 |\n" },
  { "insert": "| " },
  { "insert": "数据一致性", "attributes": { "bold": true } },
  { "insert": " | ❌ 容易出错 | ✅ 强一致性 | 外键约束保证 |\n\n" },

  { "insert": "角色体系简化", "attributes": { "header": 2 } },
  { "insert": "\n\n" },
  { "insert": "| 角色类型 | 原有定义 | 新定义 | 说明 |\n" },
  { "insert": "|----------|----------|--------|------|\n" },
  { "insert": "| 0 | 成员 | 普通成员 | 保持一致性 |\n" },
  { "insert": "| 1 | 管理员 | 部门主管 | 更明确的职责定义 |\n\n" },

  { "insert": "设计优势", "attributes": { "header": 2 } },
  { "insert": "\n" },
  { "insert": "• " },
  { "insert": "职责分离", "attributes": { "bold": true } },
  { "insert": ": 用户基础信息与职位信息分离，结构更清晰\n" },
  { "insert": "• " },
  { "insert": "多职位支持", "attributes": { "bold": true } },
  { "insert": ": 一个用户可以在多个部门担任不同职位\n" },
  { "insert": "• " },
  { "insert": "数据一致性", "attributes": { "bold": true } },
  { "insert": ": 通过外键约束保证数据完整性\n" },
  { "insert": "• " },
  { "insert": "查询优化", "attributes": { "bold": true } },
  { "insert": ": 可以根据需要查询用户基础信息或职位信息\n" },
  { "insert": "• " },
  { "insert": "扩展性强", "attributes": { "bold": true } },
  { "insert": ": 易于添加新的职位相关字段或功能\n" },
  { "insert": "• " },
  { "insert": "维护性好", "attributes": { "bold": true } },
  { "insert": ": 结构清晰，便于理解和维护\n\n" },

  { "insert": "使用示例", "attributes": { "header": 2 } },
  { "insert": "\n\n" },

  { "insert": "查询用户的所有职位", "attributes": { "header": 3 } },
  { "insert": "\n" },
  { "insert": "// 通过用户ID查询所有团队关系及其职位\n" },
  { "insert": "teamUserRelations, err := client.TeamUserRelation.\n" },
  { "insert": "    Query().\n" },
  { "insert": "    Where(teamuserrelation.UserID(userID)).\n" },
  {
    "insert": "    WithTeamMemberDepartments(func(q *ent.TeamMemberDepartmentQuery) {\n"
  },
  { "insert": "        q.WithDepartment().WithPosition()\n" },
  { "insert": "    }).\n" },
  { "insert": "    All(ctx)", "attributes": { "code": true } },
  { "insert": "\n\n" },

  { "insert": "查询部门的所有成员", "attributes": { "header": 3 } },
  { "insert": "\n" },
  { "insert": "// 通过部门ID查询所有职位关系\n" },
  { "insert": "teamMemberDepartments, err := client.TeamMemberDepartment.\n" },
  { "insert": "    Query().\n" },
  { "insert": "    Where(teammemberdepartment.DepartmentID(departmentID)).\n" },
  {
    "insert": "    WithTeamUserRelation(func(q *ent.TeamUserRelationQuery) {\n"
  },
  { "insert": "        q.WithUser()\n" },
  { "insert": "    }).\n" },
  { "insert": "    WithPosition().\n" },
  { "insert": "    All(ctx)", "attributes": { "code": true } },
  { "insert": "\n\n" },

  { "insert": "创建新的职位关系", "attributes": { "header": 3 } },
  { "insert": "\n" },
  { "insert": "// 为现有团队用户关系添加新的部门职位\n" },
  { "insert": "teamMemberDepartment, err := client.TeamMemberDepartment.\n" },
  { "insert": "    Create().\n" },
  { "insert": "    SetTeamUserRelationID(teamUserRelationID).\n" },
  { "insert": "    SetDepartmentID(departmentID).\n" },
  { "insert": "    SetPositionID(positionID).\n" },
  { "insert": "    SetRole(roleType).\n" },
  { "insert": "    SetStartTime(time.Now().Unix()).\n" },
  { "insert": "    SetIsPrimary(isPrimary).\n" },
  { "insert": "    Save(ctx)", "attributes": { "code": true } },
  { "insert": "\n\n" },

  { "insert": "数据迁移示例", "attributes": { "header": 2 } },
  { "insert": "\n\n" },

  { "insert": "原有数据迁移到新结构", "attributes": { "header": 3 } },
  { "insert": "\n" },
  { "insert": "// 原有数据结构\n" },
  { "insert": "type OldTeamUserRelation struct {\n" },
  { "insert": "    ID             uint64 `json:\"id\"`\n" },
  { "insert": "    TeamID         uint64 `json:\"team_id\"`\n" },
  { "insert": "    UserID         uint64 `json:\"user_id\"`\n" },
  { "insert": "    DepartmentID   uint64 `json:\"department_id\"`\n" },
  { "insert": "    PositionID     uint64 `json:\"position_id\"`\n" },
  { "insert": "    EmployeeNumber string `json:\"employee_number\"`\n" },
  { "insert": "    Status         uint8  `json:\"status\"`\n" },
  { "insert": "    EntryTime      int64  `json:\"entry_time\"`\n" },
  { "insert": "    RoleType       uint8  `json:\"role_type\"`\n" },
  { "insert": "    StartTime      int64  `json:\"start_time\"`\n" },
  { "insert": "    EndTime        int64  `json:\"end_time\"`\n" },
  { "insert": "    IsPrimary      uint8  `json:\"is_primary\"`\n" },
  { "insert": "    Remark         string `json:\"remark\"`\n" },
  { "insert": "}\n\n" },
  { "insert": "// 迁移到新结构\n" },
  {
    "insert": "func migrateTeamUserRelation(old *OldTeamUserRelation) error {\n"
  },
  { "insert": "    // 1. 创建基础关系\n" },
  { "insert": "    teamUserRelation, err := client.TeamUserRelation.\n" },
  { "insert": "        Create().\n" },
  { "insert": "        SetTeamID(old.TeamID).\n" },
  { "insert": "        SetUserID(old.UserID).\n" },
  { "insert": "        SetEmployeeNumber(old.EmployeeNumber).\n" },
  { "insert": "        SetStatus(old.Status).\n" },
  { "insert": "        SetEntryTime(old.EntryTime).\n" },
  { "insert": "        Save(ctx)\n" },
  { "insert": "    if err != nil {\n" },
  { "insert": "        return err\n" },
  { "insert": "    }\n\n" },
  { "insert": "    // 2. 创建部门职位关系\n" },
  { "insert": "    _, err = client.TeamMemberDepartment.\n" },
  { "insert": "        Create().\n" },
  { "insert": "        SetTeamUserRelationID(teamUserRelation.ID).\n" },
  { "insert": "        SetDepartmentID(old.DepartmentID).\n" },
  { "insert": "        SetPositionID(old.PositionID).\n" },
  { "insert": "        SetRole(old.RoleType).\n" },
  { "insert": "        SetStartTime(old.StartTime).\n" },
  { "insert": "        SetEndTime(old.EndTime).\n" },
  { "insert": "        SetIsPrimary(old.IsPrimary).\n" },
  { "insert": "        SetRemark(old.Remark).\n" },
  { "insert": "        Save(ctx)\n" },
  { "insert": " \n" },
  { "insert": "    return err\n" },
  { "insert": "}", "attributes": { "code": true } },
  { "insert": "\n\n" },

  { "insert": "迁移注意事项", "attributes": { "header": 2 } },
  { "insert": "\n" },
  { "insert": "1. " },
  { "insert": "数据迁移", "attributes": { "bold": true } },
  { "insert": ": 需要将现有数据从单一表迁移到两个新表\n" },
  { "insert": "2. " },
  { "insert": "应用代码更新", "attributes": { "bold": true } },
  { "insert": ": 需要更新所有相关的查询和操作代码\n" },
  { "insert": "3. " },
  { "insert": "API 兼容性", "attributes": { "bold": true } },
  { "insert": ": 可能需要调整相关 API 接口\n" },
  { "insert": "4. " },
  { "insert": "权限控制", "attributes": { "bold": true } },
  { "insert": ": 需要重新设计基于多职位的权限控制逻辑\n" },
  { "insert": "5. " },
  { "insert": "字段名变更", "attributes": { "bold": true } },
  { "insert": ": " },
  { "insert": "role_type", "attributes": { "code": true } },
  { "insert": " 字段更名为 " },
  { "insert": "role", "attributes": { "code": true } },
  { "insert": "，需要更新相关代码\n" }
]
